services:
  peepbot-postgres:
    image: postgres:18.3@sha256:69e8582b781cb44fa4557b98ed586fe68361e320d9b12f9707494335634f4f3d
    container_name: peepbot-postgres
    restart: always
    shm_size: 128mb
    networks:
      - homelab_default
    volumes:
      - /ssd/fast_storage/docker/peepbot-postgres:/var/lib/postgresql
    environment:
      POSTGRES_PASSWORD: &postgresPassword ${POSTGRES_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  peepbot-backend:
    image: ghcr.io/tyler-cash/peep-bot-backend:latest@sha256:027ca2f1d8c6ef6b4b1b270d398993d5600712fc3eff184fc5f3f24bf3f3ae41
    container_name: peepbot-backend
    restart: always
    networks:
      - homelab_default
    depends_on:
      peepbot-postgres:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://peepbot-postgres:5432/peepbot
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: *postgresPassword
      SPRING_PROFILES_ACTIVE: prod
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_DISCORD_CLIENT_ID: ${SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_DISCORD_CLIENT_ID}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_DISCORD_CLIENT_SECRET: ${SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_DISCORD_CLIENT_SECRET}
      DEV_TYLERCASH_DISCORD_GUILD_ID: ${DEV_TYLERCASH_DISCORD_GUILD_ID}
      DEV_TYLERCASH_DISCORD_TOKEN: ${DEV_TYLERCASH_DISCORD_TOKEN}
    healthcheck:
      disable: true
    labels:
      traefik.enable: true
      traefik.http.routers.peepbot-backend.entrypoints: websecure
      traefik.http.routers.peepbot-backend.rule: Host(`api.event.tylercash.dev`)
      traefik.http.routers.peepbot-backend.service: peepbot-backend
      traefik.http.routers.peepbot-backend.tls.certresolver: leresolver
      traefik.http.services.peepbot-backend.loadbalancer.server.port: 8080
      com.centurylinklabs.watchtower.enable: true

  peepbot-frontend:
    image: ghcr.io/tyler-cash/peep-bot-frontend:latest@sha256:4fab6abfb7e6c391ef57df217f164a370d3f4afcf5212a2001e9beae3c397206
    container_name: peepbot-frontend
    restart: always
    networks:
      - homelab_default
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:80/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      traefik.enable: true
      traefik.http.routers.peepbot-frontend.entrypoints: websecure
      traefik.http.routers.peepbot-frontend.rule: Host(`event.tylercash.dev`)
      traefik.http.routers.peepbot-frontend.service: peepbot-frontend
      traefik.http.routers.peepbot-frontend.tls.certresolver: leresolver
      traefik.http.services.peepbot-frontend.loadbalancer.server.port: 80
      com.centurylinklabs.watchtower.enable: true

  adminer:
    image: adminer:5.4.2@sha256:2fb88b98da9f0ae0157d8fcb73f447a0747b09ee8d2ff8a8e0695b30afed2116
    restart: always
    networks:
      - homelab_default
    depends_on:
      peepbot-postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      traefik.enable: true
      traefik.http.routers.peepbot-adminer.entrypoints: websecure
      traefik.http.routers.peepbot-adminer.rule: Host(`adminer.tylercash.dev`) && ClientIP(`10.0.0.0/8`)
      traefik.http.routers.peepbot-adminer.service: peepbot-adminer
      traefik.http.routers.peepbot-adminer.tls.certresolver: leresolver
      traefik.http.services.peepbot-adminer.loadbalancer.server.port: 8080

networks:
  homelab_default:
    external: true
